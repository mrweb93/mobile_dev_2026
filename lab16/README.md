# Лабораторная работа №16
## Добавление индикатора загрузки (CircularProgressIndicator) и кнопки «Повторить» при ошибке сети

**Длительность:** 1 час 30 минут  
**Цель работы:** Научиться обрабатывать состояния загрузки и ошибки при выполнении сетевых запросов, реализовать отображение индикатора загрузки (CircularProgressIndicator) и кнопки повторной попытки в случае ошибки, используя ViewModel и StateFlow в Jetpack Compose.

---

## 1. Теоретическая справка

### 1.1. Управление состояниями UI
При работе с асинхронными операциями (сетевые запросы, работа с БД) UI должен адекватно реагировать на различные состояния:
- **Loading** – данные загружаются, показываем индикатор.
- **Success** – данные успешно получены, отображаем список.
- **Error** – произошла ошибка, показываем сообщение и кнопку для повторной попытки.

В современных Android-приложениях эти состояния моделируются с помощью sealed class и хранятся в ViewModel с использованием `StateFlow` или `LiveData`.

### 1.2. Индикатор загрузки в Compose
`CircularProgressIndicator` – стандартный компонент Compose для отображения кругового прогресса. Его можно разместить по центру экрана с помощью `Box` и модификатора `align(Alignment.Center)`.

Пример:
```kotlin
Box(modifier = Modifier.fillMaxSize()) {
    CircularProgressIndicator(modifier = Modifier.align(Alignment.Center))
}
```

### 1.3. Обработка ошибок и повторный запрос
При возникновении ошибки (например, отсутствие сети) пользователю необходимо показать понятное сообщение и предложить повторить запрос. В ViewModel для этого создаётся метод `loadData()`, который вызывается повторно при нажатии на кнопку.

### 1.4. Интеграция с ViewModel
ViewModel должна предоставлять `StateFlow<UiState>`, а UI подписывается на него с помощью `collectAsStateWithLifecycle()`. Это гарантирует, что подписка будет автоматически приостановлена, когда приложение не на переднем плане.

---

## 2. Оборудование и программное обеспечение

- Персональный компьютер с ОС Windows / macOS / Linux.
- Android Studio с проектом, созданным в лабораторной работе №15 (или аналогичным проектом, выполняющим сетевые запросы).
- Эмулятор или реальное устройство с доступом в интернет.

---

## 3. Порядок выполнения работы

### Этап 1. Подготовка проекта (5 мин)

Откройте проект, созданный в лабораторной работе №15 (экран с карточками постов и изображениями). Убедитесь, что проект успешно компилируется и выполняет загрузку данных из сети.

Если у вас нет готового проекта, можно использовать код из лабораторной работы №14 или создать новый проект на основе шаблона и повторить шаги по настройке Retrofit и Coil (это займёт дополнительное время, но в рамках 1.5 часов лучше работать с уже готовым проектом).

### Этап 2. Анализ текущей реализации состояний (5 мин)

Откройте файл `PostsViewModel.kt`. Проверьте, как в нём реализовано управление состояниями. В Лаб.15 уже используется sealed class `PostsUiState` с тремя состояниями: `Loading`, `Success`, `Error`. Убедитесь, что метод `loadPosts()` корректно обновляет состояние.

Если в вашем проекте состояния ещё не реализованы, создайте sealed class по образцу:

```kotlin
sealed class PostsUiState {
    object Loading : PostsUiState()
    data class Success(val posts: List<Post>) : PostsUiState()
    data class Error(val message: String) : PostsUiState()
}
```

### Этап 3. Добавление кнопки «Повторить» на экран ошибки (15 мин)

В файле с экраном (например, `PostsScreen.kt`) найдите обработку состояния `Error`. Сейчас там, вероятно, просто отображается текст ошибки. Измените этот блок, добавив кнопку для повторной загрузки.

```kotlin
is PostsUiState.Error -> {
    Column(
        modifier = Modifier.align(Alignment.Center),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Text(
            text = "Ошибка: ${(uiState as PostsUiState.Error).message}",
            color = MaterialTheme.colorScheme.error
        )
        Button(
            onClick = { viewModel.loadPosts() },
            modifier = Modifier.padding(top = 8.dp)
        ) {
            Text("Повторить")
        }
    }
}
```

### Этап 4. Улучшение индикатора загрузки (10 мин)

В состоянии `Loading` у вас уже используется `CircularProgressIndicator`. Убедитесь, что он отображается по центру экрана и не перекрывается другими элементами. В коде выше используется `Box` с `align(Alignment.Center)`, что корректно.

При желании можно добавить текст "Загрузка..." рядом с индикатором:

```kotlin
is PostsUiState.Loading -> {
    Column(
        modifier = Modifier.align(Alignment.Center),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        CircularProgressIndicator()
        Spacer(modifier = Modifier.height(8.dp))
        Text("Загрузка данных...")
    }
}
```

### Этап 5. Тестирование с отключённым интернетом (10 мин)

Запустите приложение при включённом интернете – должен отобразиться список карточек. Затем отключите интернет (включите авиарежим) и перезапустите приложение или нажмите кнопку обновления. Должен появиться экран ошибки с кнопкой "Повторить". Включите интернет и нажмите кнопку – данные должны загрузиться.

### Этап 6. Добавление таймаута и обработки исключений (15 мин)

В репозитории или в ViewModel можно добавить обработку специфических исключений, чтобы показывать разные сообщения (например, "Нет соединения с интернетом", "Таймаут", "Сервер недоступен"). Модифицируйте `catch` блок в ViewModel:

```kotlin
try {
    val posts = repository.getPosts()
    _uiState.value = PostsUiState.Success(posts)
} catch (e: IOException) {
    _uiState.value = PostsUiState.Error("Ошибка сети: ${e.message}")
} catch (e: Exception) {
    _uiState.value = PostsUiState.Error("Неизвестная ошибка: ${e.message}")
}
```

Добавьте соответствующие импорты (`java.io.IOException`).

### Этап 7. Добавление кнопки обновления в шапку (опционально, 5 мин)

Если в приложении ещё нет кнопки обновления в `TopAppBar`, добавьте её. В Лаб.15 она уже есть. Проверьте, что она вызывает `viewModel.loadPosts()`.

### Этап 8. Финальное тестирование (5 мин)

Протестируйте все сценарии:
- Успешная загрузка.
- Загрузка с последующим обновлением.
- Ошибка сети с последующим восстановлением и повторной попыткой.
- Поведение при повороте экрана (состояние должно сохраняться).

---

## 4. Индивидуальные задания (вариативно)

Выберите одно из заданий для самостоятельной реализации:

1. **Кастомный дизайн для ошибки**  
   Добавьте иконку (например, `Icons.Default.Warning`) и более информативное сообщение. Стилизуйте кнопку.

2. **Обработка таймаута**  
   Настройте Retrofit с таймаутом (например, 5 секунд) и добавьте отдельное сообщение для таймаута.

3. **Снэкбар для ошибок**  
   Вместо отдельного экрана ошибки показывайте `Snackbar` с кнопкой "Повторить", при этом список остаётся пустым или отображаются кэшированные данные.

4. **Автоматический повтор**  
   Добавьте логику автоматического повтора запроса при ошибке (например, до 3 раз с задержкой). Используйте `retryWhen` из корутин.

---

## 5. Контрольные вопросы

1. Какие преимущества даёт использование sealed class для представления состояний UI?
2. Какой компонент Compose используется для отображения индикатора загрузки?
3. Как в Compose обработать нажатие на кнопку и вызвать метод ViewModel?
4. Почему важно обрабатывать исключения в сетевых запросах? Какие типы исключений могут возникнуть?
5. Как протестировать поведение приложения при отсутствии интернета?

---

## 6. Требования к отчёту

Отчёт должен содержать:
- Титульный лист с названием работы, ФИО, группой.
- Цель работы.
- Листинг модифицированного `PostsViewModel.kt` (с обработкой исключений).
- Листинг обновлённого экрана (функция `PostsScreen` или аналогичная).
- Скриншоты приложения в состояниях: загрузка, успех, ошибка (с кнопкой повтора).
- Ответы на контрольные вопросы.
- Вывод по работе.

---

## 7. Возможные ошибки и их решение

- **Кнопка «Повторить» не появляется** – проверьте, что состояние `Error` действительно устанавливается в ViewModel при возникновении исключения. Добавьте логирование.
- **Индикатор загрузки не исчезает** – убедитесь, что после успешной загрузки состояние меняется на `Success`. Проверьте, что исключение не выбрасывается молча.
- **Ошибка сети не обрабатывается** – в эмуляторе можно отключить интернет через настройки. Убедитесь, что используется правильный тип исключения (например, `IOException`).
- **После поворота экрана состояние сбрасывается** – используйте `viewModel()` и `collectAsStateWithLifecycle()`, это гарантирует сохранение состояния.

---

**Успешной работы!**
